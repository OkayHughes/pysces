from pysces.config import np
from pysces.spectral import _gll_points
from pysces.periodic_plane import generate_metric_terms
# (1, 3, 3)||(1, 0, 3)(1, 1, 3)(1, 2, 3)(1, 3, 3)||(1, 0, 3)
# =========||====================================||=========
# (0, 3, 0)||(0, 0, 0)(0, 1, 0)(0, 2, 0)(0, 3, 0)||(0, 0, 0)
# (0, 3, 1)||(0, 0, 1)(0, 1, 1)(0, 2, 1)(0, 3, 1)||(0, 0, 1)
# (0, 3, 2)||(0, 0, 2)(0, 1, 2)(0, 2, 2)(0, 3, 2)||(0, 0, 2)
# (0, 3, 3)||(0, 0, 3)(0, 1, 3)(0, 2, 3)(0, 3, 3)||(0, 0, 3)
# =========||====================================||=========
# (1, 3, 0)||(1, 0, 0)(1, 1, 0)(1, 2, 0)(1, 3, 0)||(1, 0, 0)
# (1, 3, 1)||(1, 0, 1)(1, 1, 1)(1, 2, 1)(1, 3, 1)||(1, 0, 1)
# (1, 3, 2)||(1, 0, 2)(1, 1, 2)(1, 2, 2)(1, 3, 2)||(1, 0, 2)
# (1, 3, 3)||(1, 0, 3)(1, 1, 3)(1, 2, 3)(1, 3, 3)||(1, 0, 3)
# =========||====================================||=========
# (0, 3, 0)||(0, 0, 0)(0, 1, 0)(0, 2, 0)(0, 3, 0)||(0, 0, 0)
# do not include self-associations
vert_redundancy_gll = {0: {(0, 0): {(1, 0, 3),
                                    (1, 3, 3),
                                    (0, 3, 0)},
                           (3, 0): {(1, 3, 3),
                                    (1, 0, 3),
                                    (0, 0, 0)},
                           (3, 3): {(0, 0, 3),
                                    (1, 0, 0),
                                    (1, 3, 0)},
                           (0, 3): {(0, 3, 3),
                                    (1, 3, 0),
                                    (1, 0, 0)},
                           (1, 0): {(1, 1, 3)},
                           (2, 0): {(1, 2, 3)},
                           (3, 1): {(0, 0, 1)},
                           (3, 2): {(0, 0, 2)},
                           (2, 3): {(1, 2, 0)},
                           (1, 3): {(1, 1, 0)},
                           (0, 1): {(0, 3, 1)},
                           (0, 2): {(0, 3, 2)}},
                       1: {(0, 0): {(0, 0, 3),
                                    (0, 3, 3),
                                    (1, 3, 0)},
                           (3, 0): {(1, 0, 0),
                                    (0, 0, 3),
                                    (0, 3, 3)},
                           (3, 3): {(1, 0, 3),
                                    (0, 0, 0),
                                    (0, 3, 0)},
                           (0, 3): {(1, 3, 3),
                                    (0, 3, 0),
                                    (0, 0, 0)},
                           (1, 0): {(0, 1, 3)},
                           (2, 0): {(0, 2, 3)},
                           (3, 1): {(1, 0, 1)},
                           (3, 2): {(1, 0, 2)},
                           (2, 3): {(0, 2, 0)},
                           (1, 3): {(0, 1, 0)},
                           (0, 2): {(1, 3, 2)},
                           (0, 1): {(1, 3, 1)}}}

# note: outermost keys are global face ids
vert_locals_ref = [{0: {(0, 0): {(0, 3, 0)},
                        (3, 0): {(0, 0, 0)},
                        (3, 3): {(0, 0, 3)},
                        (0, 3): {(0, 3, 3)},
                        (3, 1): {(0, 0, 1)},
                        (3, 2): {(0, 0, 2)},
                        (0, 1): {(0, 3, 1)},
                        (0, 2): {(0, 3, 2)}}},
                   {0: {(0, 0): {(0, 3, 0)},
                        (3, 0): {(0, 0, 0)},
                        (3, 3): {(0, 0, 3)},
                        (0, 3): {(0, 3, 3)},
                        (3, 1): {(0, 0, 1)},
                        (3, 2): {(0, 0, 2)},
                        (0, 1): {(0, 3, 1)},
                        (0, 2): {(0, 3, 2)}}}]
# note: outermost keys are processor ids
vert_sends_ref = [{1: [(0, 0, 0),
                       (0, 0, 0),
                       (0, 1, 0),
                       (0, 2, 0),
                       (0, 3, 0),
                       (0, 3, 0),
                       (0, 3, 3),
                       (0, 3, 3),
                       (0, 2, 3),
                       (0, 1, 3),
                       (0, 0, 3),
                       (0, 0, 3)]},
                  {0: [(0, 0, 0),
                       (0, 0, 0),
                       (0, 1, 0),
                       (0, 2, 0),
                       (0, 3, 0),
                       (0, 3, 0),
                       (0, 3, 3),
                       (0, 3, 3),
                       (0, 2, 3),
                       (0, 1, 3),
                       (0, 0, 3),
                       (0, 0, 3)]}]
vert_recvs_ref = [{1: [(0, 3, 3),
                       (0, 0, 3),
                       (0, 1, 3),
                       (0, 2, 3),
                       (0, 3, 3),
                       (0, 0, 3),
                       (0, 0, 0),
                       (0, 3, 0),
                       (0, 2, 0),
                       (0, 1, 0),
                       (0, 0, 0),
                       (0, 3, 0)]},
                  {0: [(0, 3, 3),
                       (0, 0, 3),
                       (0, 1, 3),
                       (0, 2, 3),
                       (0, 3, 3),
                       (0, 0, 3),
                       (0, 0, 0),
                       (0, 3, 0),
                       (0, 2, 0),
                       (0, 1, 0),
                       (0, 0, 0),
                       (0, 3, 0)]}]

def init_test_grid():
  npt = 4
  gll_pts = _gll_points[npt]["points"]
  x, y = np.meshgrid(gll_pts, gll_pts)
  x1 = np.stack((x, y + 1.0), axis=-1)
  x2 = np.stack((x, y), axis=-1)
  cart_pts = np.array([x1, x2], dtype=np.float64)
  gll_to_cube_jacobian = (np.eye(2)[np.newaxis, np.newaxis, np.newaxis, :, :] *
                          np.ones_like(cart_pts[:, :, :, 0])[:, :, :, np.newaxis, np.newaxis])
  return generate_metric_terms(cart_pts, gll_to_cube_jacobian, vert_redundancy_gll, npt, jax=False)
